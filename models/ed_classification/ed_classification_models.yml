version: 2

##  Final


models:
  - name: ed_classification__summary
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: summary
      tags: ed_classification
      materialized: table
    description: |
      ED Classification as a cube that can be summarized
    columns:
      - name: classification_order
      - name: classification_name
      - name: ccs_description_with_covid
      - name: condition_date_year
      - name: condition_date_year_month
      - name: claim_count
      - name: claim_paid_amount_sum


# Intermediate
  - name: ed_classification__int_by_ccs_description
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: by_ccs_description
      tags: ed_classification
      materialized: table
    description: ED_Summary aggregated by year, and ccs_description
    columns:
      - name: classification_order
      - name: classification_name
      - name: ccs_description_with_covid
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: ed_classification__int_by_patient_race
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: by_patient_race
      tags: ed_classification
      materialized: table
    description: ED_Summary aggregated by year, and ccs_description
    columns:
      - name: classification_order
      - name: classification_name
      - name: patient_race
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: ed_classification__int_by_provider_parent_organization
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: by_provider_parent_organization
      tags: ed_classification
      materialized: table
    description: ED_Summary aggregated by year, and ccs_description
    columns:
      - name: classification_order
      - name: classification_name
      - name: provider_parent_organization_with_provider_name
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: ed_classification__int_by_provider_practice_state
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: by_provider_practice_state
      tags: ed_classification
      materialized: table
    description: ED_Summary aggregated by year, and ccs_description
    columns:
      - name: classification_order
      - name: classification_name
      - name: provider_practice_state
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: ed_classification__int_by_year
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: by_year
      tags: ed_classification
      materialized: table
    description: ED_Summary aggregated by year
    columns:
      - name: classification_order
      - name: classification_name
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: ed_classification__int_by_year_month
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: by_year_month
      tags: ed_classification
      materialized: table
    description: ED_Summary aggregated by year month
    columns:
      - name: classification_order
      - name: classification_name
      - name: condition_date_year_month
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: ed_classification__int_merge_condition
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: merge_condition
      tags: ed_classification
      materialized: table
    description: |
      All conditions with the classifications merged on and resolved to a single
      category per condition row.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('ed_condition')

  - name: ed_classification__int_condition_with_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: condition_with_claim
      tags: ed_classification
      materialized: table
    description: |
      Filtered condition row table to classified ones. Includes additional
      information from the claim header, provider and patient tables
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('ed_condition_with_class')
    columns:
      - name: claim_id
        tests:
          - unique
          - not_null

  - name: ed_classification__int_condition_with_class
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: condition_with_class
      tags: ed_classification
      materialized: table
    description: Filtered condition row table to classified ones.
    tests:
      - dbt_utils.fewer_rows_than:
          compare_model: ref('ed_condition')

  - name: ed_classification__int_patient_list
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: patient_list
      tags: ed_classification
      materialized: table
    description: |
      ED condition rows with all available patient information joined in.
      Useful for identifying patients who have more than a certain number
      of ED visits per time period.


##  Staging

  - name: ed_classification__stg_condition
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      tags: ed_classification
      materialized: ephemeral

##  Data Quality

  - name: ed_classification__claim_categorization
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: claim_categorization
      tags: ed_classification
      materialized: table
    description: |
       For all condition rows associated with ED claims, perform a crosstab against
       the service category to double check that they really are mostly outpatient ED claims.

  - name: ed_classification__unclassified_conditions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: unclassified_conditions
      tags: ed_classification
      materialized: table
    description: |
      CCS Level Breakdown of the conditions table augmented with the probabilistic
      classification flags. Includes statistics about the codes and conditions
      that could not be classified using the ED Classification algorithm.
    columns:
      - name: ccs_description_with_covid
        description: >
          CCS Description for the ICD code in the discharge diagnosis of the conditions
          table augmented with COVID.
        tests:
          - not_null:
              config:
                severity: warn
      - name: unique_codes_in_ccs_count
        description: Number of unique condition codes that fit into the CCS descrption
      - name: unique_unclassified_codes_in_ccs_count
        description: Number of the condition diagnoses in the CCS description
      - name: condition_row_unclassified_percent
        description: >
          Percent of the discharge diagnosis condition rows that were not
          classifiable using the ED Classification algorithm. I.e. the rows with
          diagnosis codes that weren't assigned a ED classification probability, either
          because the code didn't exist the time the algorithm was created or something
          else.
      - name: unclassified_claim_paid_amount_sum
        description: Total spend associated with unclassified ED claims


  - name: ed_classification__unclassified_rows
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_ed_classification
        {% else %}ed_classification{%- endif -%}
      alias: unclassified_rows
      tags: ed_classification
      materialized: table
    description: Overall unclassified rows stats.
    columns:
      - name: condition_row_unclassified_percent
        description: Percent of discharge condition rows that were not classifiable
        tests:
          - dbt_utils.accepted_range:
              max_value: 20
              config:
                severity: warn
