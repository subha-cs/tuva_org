version: 2

##  Final


models:
  - name: ed_summary
    description: >
      ED Classification as a cube that can be summarized
    config:
      materialized: table
    columns:
      - name: classification_order
      - name: classification_name
      - name: ccs_description_with_covid
      - name: condition_date_year
      - name: condition_date_year_month
      - name: claim_count
      - name: claim_paid_amount_sum


# Intermediate
  - name: by_year
    description: ED_Summary aggregated by year
    columns:
      - name: classification_order
      - name: classification_name
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: by_year_month
    description: ED_Summary aggregated by year month
    columns:
      - name: classification_order
      - name: classification_name
      - name: condition_date_year_month
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: by_ccs_description
    description: ED_Summary aggregated by year, and ccs_description
    columns:
      - name: classification_order
      - name: classification_name
      - name: ccs_description_with_covid
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: by_patient_race
    description: ED_Summary aggregated by year, and ccs_description
    columns:
      - name: classification_order
      - name: classification_name
      - name: patient_race
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: by_provider_parent_organization
    description: ED_Summary aggregated by year, and ccs_description
    columns:
      - name: classification_order
      - name: classification_name
      - name: provider_parent_organization_with_provider_name
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: by_provider_practice_state
    description: ED_Summary aggregated by year, and ccs_description
    columns:
      - name: classification_order
      - name: classification_name
      - name: provider_practice_state
      - name: condition_date_year
      - name: claim_count
      - name: claim_paid_amount_sum

  - name: patient_list
    description: >
      ED condition rows with all available patient information joined in.
      Useful for identifying patients who have more than a certain number
      of ED visits per time period.

  - name: ed_classified_condition
    config:
      materialized: table
    description: >
      All conditions with the classifications merged on and resolved to a single
      category per condition row.
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('ed_condition')

  - name: ed_classified_condition_with_class
    description: Filtered condition row table to classified ones.
    config:
      materialized: table
    tests:
      - dbt_utils.fewer_rows_than:
          compare_model: ref('ed_condition')

  - name: ed_classified_condition_with_claim
    description: >
      Filtered condition row table to classified ones. Includes additional
      information from the claim header, provider and patient tables
    config:
      materialized: table
    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('ed_condition_with_class')
    columns:
      - name: claim_id
        tests:
          - unique
          - not_null


##  Staging

  - name: ed_condition
    description: Conditions table filtered to only those rows associated with ED claims
    config:
      materialized: table


##  Data Quality

  - name: unclassified_conditions
    description: >
      CCS Level Breakdown of the conditions table augmented with the probabilistic
      classification flags. Includes statistics about the codes and conditions
      that could not be classified using the ED Classification algorithm.
    config:
      materialized: table
    columns:
      - name: ccs_description_with_covid
        description: >
          CCS Description for the ICD code in the discharge diagnosis of the conditions
          table augmented with COVID.
        tests:
          - not_null:
              config:
                severity: warn
      - name: unique_codes_in_ccs_count
        description: Number of unique condition codes that fit into the CCS descrption
      - name: unique_unclassified_codes_in_ccs_count
        description: Number of the condition diagnoses in the CCS description
      - name: condition_row_unclassified_percent
        description: >
          Percent of the discharge diagnosis condition rows that were not
          classifiable using the ED Classification algorithm. I.e. the rows with
          diagnosis codes that weren't assigned a ED classification probability, either
          because the code didn't exist the time the algorithm was created or something
          else.
      - name: unclassified_claim_paid_amount_sum
        description: Total spend associated with unclassified ED claims
        
  - name: ed_claim_categorization
    description: >
       For all condition rows associated with ED claims, perform a crosstab against
       the service category to double check that they really are mostly outpatient ED claims.

  - name: unclassified_rows
    description: Overall unclassified rows stats.
    columns:
      - name: condition_row_unclassified_percent
        description: Percent of discharge condition rows that were not classifiable
        tests:
          - dbt_utils.accepted_range:
              max_value: 20
              config:
                severity: warn
