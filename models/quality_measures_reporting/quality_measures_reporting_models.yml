version: 2

models:
## Final
  - name: quality_measures_reporting__summary_counts
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: summary_counts
      tags: quality_measures_reporting
      materialized: table
    description: Reporting measure counts with performance rates.
    columns:
      - name: measure_id
        description: Unique measure identification number.
      - name: measure_name
        description: Name of the measure.
      - name: measure_version
        description: Version of the measure.
      - name: performance_period_begin
        description: Beginning date of the performance or measurement period.
      - name: performance_period_end
        description: Ending date of the performance or measurement period.
      - name: denominator_sum
        description: >
          The denominator sum after exclusion logic applied.
          The denominator is associated with a given patient population that 
          may be counted as eligible to meet a measure’s inclusion requirements.
      - name: numerator_sum
        description: >
          The numerator sum after exclusion logic applied.
          The numerator reflects the subset of patients in the denominator 
          for whom a particular service has been provided or for whom a 
          particular outcome has been achieved with exclusion logic applied.
      - name: performance_rate
        description: >
          Calculated performance rate. The numerator sum divided by the 
          denominator sum after exclusion logic applied and multiplied by 100.
      - name: last_update
        description: The date and timestamp of the dbt run.

  - name: quality_measures_reporting__summary_long
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: summary_long
      tags: quality_measures_reporting
      materialized: table
    description: >
      Long view of the results for the reporting version of all measures.
      Each row represents the results a measure per patient. A null for the 
      denominator indicates that the patient was not eligible for that measure.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: denominator_flag
        description: >
          The denominator is associated with a given patient population that 
          may be counted as eligible to meet a measure’s inclusion requirements.
      - name: numerator_flag
        description: >
          The numerator reflects the subset of patients in the denominator 
          for whom a particular service has been provided or for whom a 
          particular outcome has been achieved.
      - name: exclusion_flag
        description: >
          Specifications of those characteristics that would cause groups of 
          individuals to be removed from the numerator and/or denominator of 
          a measure although they experience the denominator index event.
      - name: evidence_date
        description: >
          Date of event or service that places patient in the numerator.
      - name: exclusion_date
        description: >
          Date of event or service that excludes patient from the measure.
      - name: exclusion_reason
        description: >
          Reason (usually the value set concept name) that excludes patient 
          from the measure.
      - name: performance_period_begin
        description: Beginning date of the performance or measurement period.
      - name: performance_period_end
        description: Ending date of the performance or measurement period.
      - name: measure_id
        description: Unique measure identification number.
      - name: measure_name
        description: Name of the measure.
      - name: measure_version
        description: Version of the measure.
      - name: last_update
        description: The date and timestamp of the dbt run.

  - name: quality_measures_reporting__summary_wide
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: summary_wide
      tags: quality_measures_reporting
      materialized: table
    description: >
      Wide view of the results for the reporting version of all measures.
      This model pivots measures on the patient level (i.e. one row per patient
      with flags for each measure. The false flags can be treated as care gaps
      as exclusions have been included in the pivot logic.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: nqf_2372
        description: >
          Each measure has a boolean flag which is the result of evaluating 
          the denominator, numerator, and exclusion indicators for the patient.
          A null indicates that the measure was not applicable for the patient.
      - name: last_update
        description: The date and timestamp of the dbt run.

## Intermediate
  - name: quality_measures_reporting__int_nqf2372_denominator
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_denominator
      tags: quality_measures_reporting
      materialized: table
    description: >
      Denominator logic for the reporting version of NQF 2372, Breast Cancer 
      Screening.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: age
        description: Patient's age as of the performance_period_begin date.
      - name: performance_period_begin
        description: Beginning date of the performance or measurement period.
      - name: performance_period_end
        description: Ending date of the performance or measurement period.
      - name: measure_id
        description: Unique measure identification number.
      - name: measure_name
        description: Name of the measure.
      - name: measure_version
        description: Version of the measure.
      - name: denominator_flag
        description: >
          The denominator is associated with a given patient population that 
          may be counted as eligible to meet a measure’s inclusion requirements.
      - name: last_update
        description: The date and timestamp of the dbt run.

  - name: quality_measures_reporting__int_nqf2372_exclude_advanced_illness
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_exclude_advanced_illness
      tags: quality_measures_reporting
      materialized: table
    description: >
      Exclusion logic for patients with frailty and advanced illness for 
      the reporting version of NQF 2372, Breast Cancer Screening.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: exclusion_date
        description: >
          Date of event or service that excludes patient from the measure.
      - name: exclusion_reason
        description: >
          Reason (usually the value set concept name) that excludes patient 
          from the measure.

  - name: quality_measures_reporting__int_nqf2372_exclude_dementia
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_exclude_dementia
      tags: quality_measures_reporting
      materialized: table
    description: >
      Exclusion logic for patients with frailty and taking dementia medications
      for the reporting version of NQF 2372, Breast Cancer Screening.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: exclusion_date
        description: >
          Date of event or service that excludes patient from the measure.
      - name: exclusion_reason
        description: >
          Reason (usually the value set concept name) that excludes patient 
          from the measure.

  - name: quality_measures_reporting__int_nqf2372_exclude_hospice
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_exclude_hospice
      tags: quality_measures_reporting
      materialized: table
    description: >
      Exclusion logic for patients using hospice services for the reporting 
      version of NQF 2372, Breast Cancer Screening.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: exclusion_date
        description: >
          Date of event or service that excludes patient from the measure.
      - name: exclusion_reason
        description: >
          Reason (usually the value set concept name) that excludes patient 
          from the measure.

  - name: quality_measures_reporting__int_nqf2372_exclude_institutional
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_exclude_institutional
      tags: quality_measures_reporting
      materialized: table
    description: >
      Exclusion logic for patients staying in an institution for the reporting 
      version of NQF 2372, Breast Cancer Screening.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: exclusion_date
        description: >
          Date of event or service that excludes patient from the measure.
      - name: exclusion_reason
        description: >
          Reason (usually the value set concept name) that excludes patient 
          from the measure.

  - name: quality_measures_reporting__int_nqf2372_exclude_mastectomy
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_exclude_mastectomy
      tags: quality_measures_reporting
      materialized: table
    description: >
      Exclusion logic for patients with a mastectomy for the reporting 
      version of NQF 2372, Breast Cancer Screening.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: exclusion_date
        description: >
          Date of event or service that excludes patient from the measure.
      - name: exclusion_reason
        description: >
          Reason (usually the value set concept name) that excludes patient 
          from the measure.

  - name: quality_measures_reporting__int_nqf2372_exclude_palliative
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_exclude_palliative
      tags: quality_measures_reporting
      materialized: table
    description: >
      Exclusion logic for patients using palliative services for the reporting 
      version of NQF 2372, Breast Cancer Screening.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: exclusion_date
        description: >
          Date of event or service that excludes patient from the measure.
      - name: exclusion_reason
        description: >
          Reason (usually the value set concept name) that excludes patient 
          from the measure.

  - name: quality_measures_reporting__int_nqf2372_exclusions
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_exclusions
      tags: quality_measures_reporting
      materialized: table
    description: >
      Combined exclusion logic for the reporting version of NQF 2372, Breast Cancer 
      Screening.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: performance_period_begin
        description: Beginning date of the performance or measurement period.
      - name: performance_period_end
        description: Ending date of the performance or measurement period.
      - name: measure_id
        description: Unique measure identification number.
      - name: measure_name
        description: Name of the measure.
      - name: measure_version
        description: Version of the measure.
      - name: exclusion_date
        description: >
          Date of event or service that excludes patient from the measure.
      - name: exclusion_reason
        description: >
          Reason (usually the value set concept name) that excludes patient 
          from the measure.
      - name: exclusion_flag
        description: >
          Specifications of those characteristics that would cause groups of 
          individuals to be removed from the numerator and/or denominator of 
          a measure although they experience the denominator index event.
      - name: last_update
        description: The date and timestamp of the dbt run.

  - name: quality_measures_reporting__int_nqf2372_long
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_long
      tags: quality_measures_reporting
      materialized: table
    description: >
      Final preparation of the reporting version of NQF 2372, Breast Cancer 
      Screening before combining with other measures.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: denominator_flag
        description: >
          The denominator is associated with a given patient population that 
          may be counted as eligible to meet a measure’s inclusion requirements.
      - name: numerator_flag
        description: >
          The numerator reflects the subset of patients in the denominator 
          for whom a particular service has been provided or for whom a 
          particular outcome has been achieved.
      - name: exclusion_flag
        description: >
          Specifications of those characteristics that would cause groups of 
          individuals to be removed from the numerator and/or denominator of 
          a measure although they experience the denominator index event.
      - name: evidence_date
        description: >
          Date of event or service that places patient in the numerator.
      - name: exclusion_date
        description: >
          Date of event or service that excludes patient from the measure.
      - name: exclusion_reason
        description: >
          Reason (usually the value set concept name) that excludes patient 
          from the measure.
      - name: performance_period_begin
        description: Beginning date of the performance or measurement period.
      - name: performance_period_end
        description: Ending date of the performance or measurement period.
      - name: measure_id
        description: Unique measure identification number.
      - name: measure_name
        description: Name of the measure.
      - name: measure_version
        description: Version of the measure.
      - name: last_update
        description: The date and timestamp of the dbt run.

  - name: quality_measures_reporting__int_nqf2372_numerator
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _int_nqf2372_numerator
      tags: quality_measures_reporting
      materialized: table
    description: >
      Numerator logic for the reporting version of NQF 2372, Breast Cancer 
      Screening.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: performance_period_begin
        description: Beginning date of the performance or measurement period.
      - name: performance_period_end
        description: Ending date of the performance or measurement period.
      - name: measure_id
        description: Unique measure identification number.
      - name: measure_name
        description: Name of the measure.
      - name: measure_version
        description: Version of the measure.
      - name: evidence_date
        description: >
          Date of event or service that places patient in the numerator.
      - name: numerator_flag
        description: >
          The numerator reflects the subset of patients in the denominator 
          for whom a particular service has been provided or for whom a 
          particular outcome has been achieved.
      - name: last_update
        description: The date and timestamp of the dbt run.

## Staging
  - name: quality_measures_reporting__stg_core__condition
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _stg_condition
      tags: quality_measures_reporting
      materialized: ephemeral
    description: Staging conditions from core.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
        tests:
          - not_null:
              severity: warn
      - name: condition_date
        description: Date in which the condition occured.
      - name: code_type
        description: The type of condition code.
      - name: code
        description: The condition code.
      - name: last_update
        description: The date and timestamp of the dbt run.

  - name: quality_measures_reporting__stg_core__patient
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _stg_patient
      tags: quality_measures_reporting
      materialized: ephemeral
    description: Staging eligibility from the input layer.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
        tests:
          - not_null:
              severity: warn
      - name: gender
        description: Biological sex of the patient.
        tests:
          - not_null:
              severity: warn
          - accepted_values:
              values: ['female', 'male']
              severity: warn
      - name: birth_date
        description: Date the patient was born.
        tests:
          - not_null:
              severity: warn
      - name: death_date
        description: The death date of the patient if there is one.
      - name: last_update
        description: The date and timestamp of the dbt run.

  - name: quality_measures_reporting__stg_core__procedure
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _stg_procedure
      tags: quality_measures_reporting
      materialized: ephemeral
    description: Staging procedures from core.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
        tests:
          - not_null:
              severity: warn
      - name: procedure_date
        description: Date when the procedure was performed.
      - name: code_type
        description: The type of condition code.
      - name: code
        description: The condition code.
      - name: last_update
        description: The date and timestamp of the dbt run.

  - name: quality_measures_reporting__stg_medical_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _stg_medical_claim
      tags: quality_measures_reporting
      materialized: ephemeral
    description: Staging medical claims from the input layer.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: claim_start_date
        description: Start date for the claim.
      - name: claim_end_date
        description: End date for the claim.
      - name: place_of_service
        description: Place of service for the claim (professional claims only).
      - name: hcpcs_code
        description: HCPCS level 1 or level 2 code for the claim line.
      - name: last_update
        description: The date and timestamp of the dbt run.


  - name: quality_measures_reporting__stg_pharmacy_claim
    config:
      schema: |
        {%- if var('tuva_schema_prefix',None) != None -%}{{var('tuva_schema_prefix')}}_quality_measures_reporting{% else %}quality_measures_reporting{%- endif -%}
      alias: _stg_pharmacy_claim
      tags: quality_measures_reporting
      materialized: ephemeral
    description: Staging pharmacy claims from the input layer.
    columns:
      - name: patient_id
        description: Unique patient_id for each person.
      - name: dispensing_date
        description: Date the prescription was filled.
      - name: ndc_code
        description: National drug code on the claim.
      - name: paid_date
        description: Date the claim was paid.
      - name: last_update
        description: The date and timestamp of the dbt run.